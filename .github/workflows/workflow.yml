name: Build and Deploy

on:
  push:
    branches: [ "cicd", "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # Git ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
      - uses: actions/checkout@v3

      # JDK 17 ì„¤ì •
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # Gradle ìºì‹± (ë¹Œë“œ ì‹œê°„ ë‹¨ì¶•)
      - name: Gradle Caching
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # Gradle ë¹Œë“œ
      - name: Build with Gradle
        run: ./gradlew clean build -x test

      # Docker Hub ë¡œê·¸ì¸
      - name: Docker Hub Login
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Docker ë¹Œë“œ, í‘¸ì‰¬
      - name: Docker Build & Push Docker Image
        run: |
          echo "ğŸ³ Building Docker image"
           docker build -t ${{ secrets.MY_DOCKER_ID }}/graduate:latest .
          
           echo "ğŸš€ Pushing Docker image"
           docker push ${{ secrets.MY_DOCKER_ID }}/graduate:latest

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      # ê¹ƒí—ˆë¸Œ ë ˆí¬ì§€í† ë¦¬ ì½”ë“œ ë‹¤ìš´ë¡œë“œ
      - name: Checkout repository
        uses: actions/checkout@v4

      # íŒŒì¼ ë³µì‚¬
      - name: Copy docker-compose.yml to Server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.PRIVATE_KEY }}
          source: "docker-compose.yml,prometheus.yml"
          target: "~/app/"  # ì„œë²„ì˜ ì €ì¥ ê²½ë¡œ

      # ì„œë²„ì— ë°°í¬
      - name: Deploy to Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }} # EC2 í¼ë¸”ë¦­ IP
          username: ${{ secrets.USERNAME }}   # í™ˆì„œë²„ SSH ê³„ì • (ex: ubuntu)
          key: ${{ secrets.PRIVATE_KEY }}  # PEM í‚¤
          script: |
            cd ~/app
            
            # Create .env file
            printf "${{ secrets.ENV_FILE }}" > .env
            
            # 1ï¸âƒ£ ìµœì‹  Docker ì´ë¯¸ì§€ í’€
            docker compose pull
            # 2ï¸âƒ£ ì´ì „ ì»¨í…Œì´ë„ˆ ì‚­ì œ
            docker compose down
            # 3ï¸âƒ£ ì»¨í…Œì´ë„ˆì™€ ì„œë¹„ìŠ¤ë¥¼ Docker Composeë¡œ ì‹¤í–‰
            docker compose up -d
            # 4ï¸âƒ£ ë¶ˆí•„ìš”í•œ ì´ë¯¸ì§€ ì‚­ì œ
            docker image prune -f